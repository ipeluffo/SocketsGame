<!DOCTYPE html>
<html>
    <head>        
        <title>Sockets Game!</title>
        <meta charset='utf-8'> 

        <!-- Bootstrap dependencies -->
        <link rel="stylesheet" type="text/css" href="./css/bootstrap.css">
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
        <script type="text/javascript" src="./js/bootstrap.js"></script>
        <!-- ********************** -->

        <!-- Socket dependencies -->
        <script src="/socket.io/socket.io.js"></script>
        <!-- ******************* -->

        <style type="text/css">
            .runButton {
                height: 70px;
                width: 100px;
                margin-right: 10px;
            }

            .container {
                width: 900px;
            }

            .userTrack {
                margin-bottom: 10px;
            }
        </style>

        <script type="text/javascript">
            var socket;
            var user;

            var raceStarted = false;

            var socketInitialization = function(username){
                var welcome = document.getElementById("welcome");
                var allUsers = $("#users");
                var progress = document.getElementById("progress");
                var results = document.getElementById("results");

                socket = io.connect('http://'+window.location.hostname+':3250');

                socket.emit("userEnters", { 'username' : username });

                socket.on("userAccepted", function(data){
                    user = data;
                });

                socket.on('updateUsers', function (data) {
                    for (var i=0; i < data.users.length; i++){
                        var userHomer = $("#user"+data.users[i].id);
                        if (userHomer.length > 0){
                            userHomer.animate({
                                "margin-left": data.users[i].clicks
                            }, 50);
                        }else{
                            // allUsers.append('<div class="row-fluid userTrack" id="userContent'+data.users[i].id+'"><div class="span12"><button class="btn btn-success runButton" onclick="sendClick();">Run '+data.users[i].name+'!</button><div style="display:inline-block; width:286px;"><img id="user'+data.users[i].id+'" src="./img/run_homer_run.png" style="height:100px;"/></div><img src="./img/donut.jpg" style="height:100px;"><hr/></div></div>');

                            // With Label
                            //allUsers.append('<div class="row-fluid userTrack" id="userContent'+data.users[i].id+'"><div class="span12"><span class="label label-success">'+data.users[i].name+'</span><div style="display:inline-block; width:286px;"><img id="user'+data.users[i].id+'" src="./img/run_homer_run.png" style="height:100px;"/></div><img src="./img/donut.jpg" style="height:100px;"><hr/></div></div>');

                            // For table
                            allUsers.append('<tr id="userContent'+data.users[i].id+'"><td><span class="label label-success">'+data.users[i].name+'</span></td><td><div style="display:inline-block; width:286px;"><img id="user'+data.users[i].id+'" src="./img/run_homer_run.png" style="height:100px;"/></div><img src="./img/donut.jpg" style="height:100px;"></td></tr>');
                        }
                    }
                });

                socket.on("removeUser", function(user) {
                    var userContent = $("#userContent"+user.id);
                    if (userContent.length > 0){
                        userContent.remove();
                    }
                });

                socket.on('update', function (data) {
                    progress.innerHTML = data.currentWidth;
                    progress.style.width = parseInt(data.currentWidth) + "px";
                });

                socket.on('win', function (data) {
                    raceStarted = false;
                    $("#winnerUsername").text(data.user.name);
                    $("#userWinModal").modal({
                        backdrop : 'static',
                        keyboard : false
                    });
                });

                socket.on('raceStarted', function(data){
                    showRaceCountModal();
                });

                socket.on('raceRestarted', function(){
                    raceStarted = false;
                });
            };

            var showRaceCountModal = function(){
                var raceCountModal = $("#raceCountModal");
                    raceCountModal.modal({
                        backdrop : 'static',
                        keyboard : false
                    });

                var i = 5;
                timer = setInterval(function(){
                    if (i>0){
                        $("#raceCount").text(i+"");
                        i = i-1; 
                    }else{
                        clearInterval(timer);
                        $("#raceCount").text("Go go go!");
                        raceCountModal.modal('hide');
                        raceStarted = true;

                    }
                },1000);
            };

            var sendClick = function(){
                if (raceStarted)
                    socket.emit("click", user);
            };

            $(function(){
                $('#usernameFormModal').modal({
                    backdrop: 'static',
                    keyboard: false
                });

                $("#usernameForm").submit(function(){
                    var usernameInput = $("#usernameInput");
                    socketInitialization(usernameInput.val());
                    $("#usernameFormModal").modal("hide");
                    // Stop the normal action
                    return false;
                });
            });

            var startRace = function(){
                socket.emit('startRace');
            };

            var restartRace = function(){
                socket.emit('restartRace');
            };

        </script>
    </head>

    <body class="main">

        <div id="raceCountModal" class="modal hide fade">
            <div class="modal-body">
                <h3>La carrera empieza en <span id="raceCount"></span></h3>
            </div>
        </div>

        <div id="userWinModal" class="modal hide fade">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h1>User <span id="winnerUsername"></span> rocks!</h1>
            </div>
            <div style="text-align:center;" class="modal-body">
                <img style="height:300px;" src="./img/homer-woohoo-big.jpg">
            </div>
        </div>

        <div id="usernameFormModal" class="modal hide fade">
            <div class="modal-header">
                <h3>Welcome to Sockets Game!</h3>
            </div>

            <div class="modal-body">
                <form id="usernameForm">
                    <fieldset>
                        <label>Nickname</label>
                        <input type="text" id="usernameInput" placeholder="Enter a great nicknameâ€¦" required>
                    </fieldset>
                </form>
            </div>

            <div class="modal-footer">
                <button onclick="$('#usernameForm').submit();" type="submit" class="btn">Play!</button>
            </div>
        </div>        

        <div class="container">
            <div class="row-fluid">
                <div class="span12 hero-unit well">
                    <h2>Welcome to SocketsGame!</h2>
                    <p>
                        Presiona las teclas para hacer correr a Homero
                    </p>
                    <p>
                        <button onclick="startRace();" class="btn btn-primary">Start Race!</button>
                        <button onclick="restartRace();" class="btn btn btn-danger">Restart Race!</button>
                    </p>
                </div>
            </div>

            <div class="row-fluid">
                <div style="padding-top: 4px; padding-bottom: 4px;" class="span3 well well-small">
                    <h4>Tecla: <span></span></h4>
                </div>
            </div>

            <div class="row-fluid">
                <div class="span12">
                    <table class="table table-bordered">
                        <tbody id="users">

                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- <div id="users" class="container">
        </div> -->

    </body>
</html>

